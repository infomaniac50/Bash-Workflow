#!/bin/bash
python_bin=`type -fp python2`
dropbox_py=`type -fp dropbox.py`
userbin="${HOME}/bin/"

source ${BASHWF}/bashwf

function download_py()
{
    if [[ ! -d $userbin ]]; then
      echo_warn "Your user bin directory $userbin does not exist."
      if askyesno "Would you like me to create it?"; then
        echo "mkdir -p $userbin"
        mkdir -p $userbin
      fi
    fi

    if askyesno "dropbox.py not found. Do you want me to fetch it?"; then
      if [[ ! -d $userbin ]]; then
        echo_fail "Aborting..."
        echo_fail "Can not download dropbox.py to the non existent directory $userbin."
        exit 1
      fi

      echo_info "Downloading dropbox.py to $dropbox_py"
      curl -LSs 'https://www.dropbox.com/download?dl=packages/dropbox.py' > $dropbox_py
      echo_pass "Download Complete"
      echo_info "Run your command again."
    fi
}

function update()
{
  # It's all lies here.
  # dropbox.py seems to return a boolean value instead of an exit code.
  if ! /usr/bin/env python2 $dropbox_py running; then
    was_running="yes"
  else
    was_running="no"
  fi

  if [[ $was_running == "yes" ]]; then
    /usr/bin/env python2 $dropbox_py stop
  fi

  echo "Updating Dropbox..."

  arch=`uname -m`
  [ $arch == 'i686' ] && arch='x86'

  echo_info "Downloading https://www.dropbox.com/download?plat=lnx.$arch"
  cd ~ && curl -L "https://www.dropbox.com/download?plat=lnx.$arch" | tar xzf -

  if [[ $was_running == "yes" ]]; then
    /usr/bin/env python2 $dropbox_py start
  fi

  echo "Done"
}

function about()
{
  echo_info "Dropbox Update Helper\n"

  echo "A bash script to update dropbox using dropbox.py."
  echo "As such it relies on dropbox.py for its pass-through functions."
  echo "This script can also fetch dropbox.py from dropbox.com if you wish."
  echo ""

  echo_info "dropbox helper update:"
  echo -e "\tUpdate the dropbox daemon from dropbox.com"
  echo ""

  echo_info "dropbox helper about:"
  echo -e "\tShow this screen."
}

if [[ ! -f $dropbox_py ]]; then
  download_py
fi

if [[ $1 == "helper" ]]; then
  shift

  case "$1" in
    'about')
      about
    ;;
    'update')
      update
    ;;
    *)
      about
    ;;
  esac
else
  echo_info "Dropbox Update Helper"
  echo_info "Run \"dropbox helper\" for more info.\n"
  /usr/bin/env python2 $dropbox_py $@
fi
